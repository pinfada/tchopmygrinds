<!-- TchopMyGrinds - Interface principale avec Tailwind CSS pur -->
<div class="relative w-full h-screen bg-gray-50 overflow-hidden">
  
  <!-- Header Navigation Mobile -->
  <header class="lg:hidden fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-sm shadow-sm z-50 safe-top">
    <div class="flex items-center justify-between px-4 py-3">
      <!-- Logo -->
      <div class="flex items-center space-x-2">
        <span class="text-2xl">üçå</span>
        <span class="font-display font-bold text-xl text-primary-600">TchopMyGrinds</span>
      </div>
      
      <!-- Actions -->
      <div class="flex items-center space-x-3">
        <!-- Geolocation button -->
        <button 
          ng-click="getCurrentLocation()" 
          class="btn-icon bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-primary-600"
          aria-label="Ma position">
          <span class="text-lg">üìç</span>
        </button>
        
        <!-- Cart -->
        <button 
          ng-click="openCart()" 
          class="btn-icon bg-primary-100 hover:bg-primary-200 text-primary-600 relative">
          <span class="text-lg">üõí</span>
          <span 
            ng-if="cartItemsCount > 0" 
            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-medium">
            {{cartItemsCount}}
          </span>
        </button>
        
        <!-- Menu -->
        <button 
          ng-click="toggleMobileMenu()" 
          class="btn-icon bg-gray-100 hover:bg-gray-200 text-gray-600"
          aria-label="Menu">
          <i class="fa fa-bars"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Carte plein √©cran avec contr√¥les superpos√©s -->
  <div class="absolute inset-0 pt-16 lg:pt-0">
    <!-- Conteneur carte -->
    <div id="map" class="absolute inset-0 rounded-none lg:rounded-xl"></div>

    <!-- Barre de recherche flottante -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-11/12 max-w-4xl z-40">
      <div class="card bg-white/95 backdrop-blur-sm shadow-xl">
        <div class="p-4">
          <!-- Formulaire de recherche -->
          <form ng-submit="searchProductNearby()" class="space-y-4">
            <!-- Champ de recherche principal -->
            <div class="flex flex-col lg:flex-row gap-3">
              <div class="flex-1 relative">
                <input 
                  type="text" 
                  ng-model="searchQuery" 
                  placeholder="Que cherchez-vous ? (banane plantain, tomate, pain...)" 
                  ng-keyup="onSearchKeyUp($event)"
                  class="w-full px-4 py-3 pr-12 text-base border-2 border-gray-200 rounded-xl focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all duration-200 placeholder-gray-500"
                  autocomplete="off">
                
                <!-- Ic√¥ne de recherche -->
                <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400">
                  <i class="fa fa-search" ng-if="!isSearching"></i>
                  <div class="spinner" ng-if="isSearching"></div>
                </div>

                <!-- Suggestions dropdown -->
                <div 
                  ng-if="showSuggestions && suggestions.length" 
                  class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-100 max-h-64 overflow-y-auto z-50">
                  <div 
                    ng-repeat="suggestion in suggestions track by $index" 
                    ng-click="selectSuggestion(suggestion)"
                    ng-class="{'bg-primary-50 text-primary-700': selectedSuggestionIndex === $index, 'hover:bg-gray-50': selectedSuggestionIndex !== $index}"
                    class="flex items-center px-4 py-3 cursor-pointer border-b border-gray-50 last:border-0 transition-colors duration-150">
                    <span class="mr-3 text-gray-400">üîç</span>
                    <span class="font-medium">{{suggestion}}</span>
                  </div>
                </div>
              </div>

              <!-- S√©lecteur de rayon -->
              <div class="relative">
                <button 
                  type="button"
                  ng-click="radiusDropdownOpen = !radiusDropdownOpen"
                  class="w-full lg:w-48 px-4 py-3 bg-white border-2 border-gray-200 rounded-xl hover:border-gray-300 focus:border-primary-500 focus:ring-4 focus:ring-primary-100 transition-all duration-200 flex items-center justify-between">
                  <span class="font-medium text-gray-700">{{searchRadius}}km</span>
                  <i class="fa fa-chevron-down transform transition-transform" ng-class="{'rotate-180': radiusDropdownOpen}"></i>
                </button>

                <!-- Dropdown rayon -->
                <div 
                  ng-if="radiusDropdownOpen" 
                  class="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden z-50">
                  <button 
                    type="button"
                    ng-repeat="radius in [5, 15, 25, 50]"
                    ng-click="setSearchRadius(radius); radiusDropdownOpen = false"
                    ng-class="{'bg-primary-50 text-primary-700': searchRadius === radius}"
                    class="w-full px-4 py-3 text-left hover:bg-gray-50 transition-colors duration-150 border-b border-gray-50 last:border-0">
                    {{radius}} km
                  </button>
                </div>
              </div>

              <!-- Bouton de recherche -->
              <button 
                type="submit" 
                ng-disabled="!searchQuery || isSearching"
                class="btn-primary btn-lg lg:w-auto whitespace-nowrap">
                <i class="fa fa-search mr-2" ng-if="!isSearching"></i>
                <div class="spinner mr-2" ng-if="isSearching"></div>
                <span ng-if="!isSearching">Chercher</span>
                <span ng-if="isSearching">Recherche...</span>
              </button>
            </div>
          </form>

          <!-- Suggestions populaires -->
          <div ng-if="!searchQuery && !hasSearched" class="mt-4">
            <p class="text-sm text-gray-600 mb-3">Suggestions populaires :</p>
            <div class="flex flex-wrap gap-2">
              <button 
                ng-repeat="suggestion in popularProducts track by $index" 
                ng-click="searchQuery = suggestion; searchProductNearby()"
                class="px-3 py-2 bg-gradient-to-r from-primary-50 to-plantain-50 hover:from-primary-100 hover:to-plantain-100 text-primary-700 rounded-full text-sm font-medium transition-all duration-200 hover:scale-105">
                {{suggestion}}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Panneau de r√©sultats (drawer) -->
    <div 
      ng-if="hasSearched" 
      class="absolute bottom-0 left-0 right-0 lg:left-6 lg:top-28 lg:bottom-6 lg:w-96 lg:right-auto z-30">
      
      <!-- Contenu drawer -->
      <div class="mobile-drawer lg:mobile-drawer-open bg-white/95 backdrop-blur-sm shadow-2xl border border-gray-100 lg:rounded-xl h-3/5 lg:h-auto lg:max-h-full overflow-hidden">
        
        <!-- Header du drawer -->
        <div class="flex items-center justify-between p-4 border-b border-gray-100 bg-white/90">
          <!-- Titre -->
          <div class="flex-1">
            <div ng-if="searchResults.length" class="flex items-center text-lg font-semibold text-gray-900">
              <span class="inline-flex items-center justify-center w-8 h-8 bg-primary-100 text-primary-700 rounded-full text-sm font-bold mr-3">
                {{searchResults.length}}
              </span>
              <span>vendeur{{searchResults.length > 1 ? 's' : ''}} trouv√©{{searchResults.length > 1 ? 's' : ''}}</span>
            </div>
            
            <div ng-if="noResults" class="flex items-center text-lg font-semibold text-yellow-700">
              <span class="mr-3 text-xl">üòî</span>
              <span>Aucun vendeur trouv√©</span>
            </div>
          </div>

          <!-- Controls -->
          <div class="flex items-center space-x-2">
            <!-- Toggle view -->
            <div class="flex bg-gray-100 rounded-lg p-1">
              <button 
                ng-click="setViewMode('list')"
                ng-class="{'bg-white shadow-sm text-primary-600': viewMode === 'list', 'text-gray-600 hover:text-gray-800': viewMode !== 'list'}"
                class="px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200">
                <i class="fa fa-list mr-1"></i>
                Liste
              </button>
              <button 
                ng-click="setViewMode('map')"
                ng-class="{'bg-white shadow-sm text-primary-600': viewMode === 'map', 'text-gray-600 hover:text-gray-800': viewMode !== 'map'}"
                class="px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200">
                <i class="fa fa-map mr-1"></i>
                Carte
              </button>
            </div>
          </div>
        </div>

        <!-- Contenu scrollable -->
        <div class="flex-1 overflow-y-auto">
          
          <!-- Message aucun r√©sultat -->
          <div ng-if="noResults" class="p-6">
            <div class="alert alert-warning">
              <div class="flex items-start space-x-3">
                <span class="text-2xl">üîç</span>
                <div class="flex-1">
                  <h3 class="font-semibold text-yellow-800 mb-2">Produit non trouv√©</h3>
                  <p class="text-yellow-700 mb-4">
                    Aucun vendeur de "<strong>{{searchQuery}}</strong>" dans un rayon de {{searchRadius}}km.
                  </p>
                  
                  <!-- Bouton manifestation d'int√©r√™t -->
                  <button 
                    ng-click="showInterestModal()" 
                    class="btn-primary w-full mb-3">
                    <span class="mr-2">üîî</span>
                    Manifester mon int√©r√™t
                  </button>
                  
                  <p class="text-sm text-gray-600">
                    Nous vous alerterons d√®s qu'un vendeur sera disponible dans votre zone.
                  </p>
                </div>
              </div>
            </div>

            <!-- Produits alternatifs -->
            <div ng-if="alternativeProducts.length" class="mt-6">
              <h4 class="font-medium text-gray-900 mb-3">Produits similaires disponibles :</h4>
              <div class="flex flex-wrap gap-2">
                <button 
                  ng-repeat="alt in alternativeProducts track by $index" 
                  ng-click="searchQuery = alt; searchProductNearby()"
                  class="px-3 py-2 border border-primary-300 text-primary-700 rounded-lg hover:bg-primary-50 text-sm font-medium transition-colors duration-200">
                  {{alt}}
                </button>
              </div>
            </div>
          </div>

          <!-- Liste des r√©sultats -->
          <div ng-if="searchResults.length && viewMode === 'list'" class="p-4 space-y-4">
            <div 
              ng-repeat="result in searchResults | orderBy:'distance' track by result.id" 
              ng-click="selectMerchant(result)"
              class="merchant-card cursor-pointer">
              
              <div class="card-body">
                <!-- Header merchant -->
                <div class="flex items-start justify-between mb-4">
                  <div class="flex items-start space-x-3">
                    <!-- Ic√¥ne commerce -->
                    <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-primary-100 to-plantain-100 rounded-xl flex items-center justify-center text-xl">
                      <span ng-if="result.commerceType === 'sedentary'">üè™</span>
                      <span ng-if="result.commerceType === 'itinerant'">üöê</span>
                    </div>
                    
                    <!-- Info commerce -->
                    <div class="flex-1 min-w-0">
                      <h3 class="font-semibold text-gray-900 text-lg mb-1 truncate">
                        {{result.commerceName}}
                      </h3>
                      <div class="flex items-center text-gray-600 text-sm mb-2">
                        <span class="mr-1">üìç</span>
                        <span>{{result.ville}} ‚Ä¢ </span>
                        <span class="font-medium text-primary-600 ml-1">{{result.distance | number:1}} km</span>
                      </div>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" 
                            ng-class="{'bg-banana-100 text-banana-800': result.commerceType === 'itinerant', 'bg-plantain-100 text-plantain-800': result.commerceType === 'sedentary'}">
                        {{result.commerceType === 'itinerant' ? 'Ambulant' : 'Commerce fixe'}}
                      </span>
                    </div>
                  </div>

                  <!-- Prix et stock -->
                  <div class="text-right flex-shrink-0">
                    <div class="text-xl font-bold text-primary-600 mb-1">
                      {{result.prix | currency:'FCFA '}}
                    </div>
                    <div class="flex items-center justify-end">
                      <span ng-if="result.stock > 0" class="badge badge-success">
                        ‚úÖ {{result.stock}} dispo
                      </span>
                      <span ng-if="result.stock === 0" class="badge badge-danger">
                        ‚ùå Rupture
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-2">
                  <button 
                    ng-if="result.stock > 0"
                    ng-click="addToCartFromSearch(result); $event.stopPropagation()"
                    class="btn-primary flex-1 sm:flex-initial">
                    <span class="mr-2">üõí</span>
                    Ajouter au panier
                  </button>
                  
                  <button 
                    ng-if="result.stock === 0"
                    ng-click="notifyWhenAvailable(result); $event.stopPropagation()"
                    class="btn-secondary flex-1 sm:flex-initial border-yellow-300 text-yellow-700 hover:bg-yellow-50">
                    <span class="mr-2">üîî</span>
                    M'alerter
                  </button>
                  
                  <button 
                    ng-click="viewMerchantDetails(result); $event.stopPropagation()"
                    class="btn-secondary flex-1 sm:flex-initial">
                    <span class="mr-2">üëÅÔ∏è</span>
                    D√©tails
                  </button>
                </div>

                <!-- Autres produits -->
                <div ng-if="result.otherProducts && result.otherProducts.length" class="mt-4 pt-4 border-t border-gray-100">
                  <p class="text-sm text-gray-600 mb-2">Autres produits disponibles :</p>
                  <div class="flex flex-wrap gap-1">
                    <span 
                      ng-repeat="product in result.otherProducts | limitTo:4 track by $index" 
                      class="inline-block px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-md">
                      {{product}}
                    </span>
                    <span ng-if="result.otherProducts.length > 4" class="inline-block px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-md">
                      +{{result.otherProducts.length - 4}} autres
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Action Button - Position fixe -->
    <button 
      ng-if="!hasSearched" 
      ng-click="quickSearch()"
      class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-primary-500 to-plantain-500 hover:from-primary-600 hover:to-plantain-600 text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 z-50 safe-bottom flex items-center justify-center">
      <span class="text-xl">üîç</span>
    </button>

    <!-- Map overlay pour √©tat initial -->
    <div ng-if="!hasSearched" class="absolute inset-0 bg-black/20 flex items-center justify-center z-20 pointer-events-none">
      <div class="bg-white/95 backdrop-blur-sm rounded-2xl p-8 text-center shadow-2xl animate-fade-in max-w-sm mx-4">
        <div class="text-4xl mb-4">üó∫Ô∏è</div>
        <h3 class="font-display font-bold text-xl text-gray-900 mb-2">Explorez votre r√©gion</h3>
        <p class="text-gray-600 mb-6">D√©couvrez les vendeurs de bananes plantain autour de vous</p>
        <button 
          ng-click="getCurrentLocation()" 
          class="btn-primary w-full pointer-events-auto">
          <span class="mr-2">üìç</span>
          Localiser ma position
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal manifestation d'int√©r√™t avec Tailwind -->
<div ng-if="showInterestForm" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-scale-up">
    <!-- Header modal -->
    <div class="flex items-center justify-between p-6 border-b border-gray-100">
      <h3 class="text-xl font-bold text-gray-900">Manifester votre int√©r√™t</h3>
      <button 
        ng-click="hideInterestModal()"
        class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors duration-200">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <!-- Corps modal -->
    <div class="p-6">
      <div class="flex items-center space-x-3 mb-4">
        <span class="text-2xl">üîî</span>
        <p class="text-gray-700">
          Nous vous alerterons d√®s qu'un vendeur de "<strong class="text-primary-600">{{searchQuery}}</strong>" sera disponible dans votre zone.
        </p>
      </div>

      <!-- Formulaire -->
      <div class="space-y-4">
        <div>
          <label class="form-label">Message personnel (optionnel)</label>
          <textarea 
            ng-model="interestMessage" 
            class="form-textarea" 
            rows="3"
            placeholder="Ex: Je recherche des bananes plantain tr√®s m√ªres pour faire du alloco..."></textarea>
        </div>

        <!-- R√©sum√© -->
        <div class="bg-gray-50 rounded-lg p-4 space-y-2">
          <div class="flex justify-between text-sm">
            <span class="font-medium text-gray-600">Produit :</span>
            <span class="text-gray-900">{{searchQuery}}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="font-medium text-gray-600">Zone de recherche :</span>
            <span class="text-gray-900">{{searchRadius}}km autour de vous</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer modal -->
    <div class="flex justify-end space-x-3 p-6 border-t border-gray-100">
      <button ng-click="hideInterestModal()" class="btn-secondary">
        Annuler
      </button>
      <button 
        ng-click="submitInterest()" 
        ng-disabled="isSubmittingInterest"
        class="btn-primary">
        <span ng-if="!isSubmittingInterest" class="mr-2">üîî</span>
        <div ng-if="isSubmittingInterest" class="spinner mr-2"></div>
        <span ng-if="!isSubmittingInterest">Confirmer mon int√©r√™t</span>
        <span ng-if="isSubmittingInterest">Envoi en cours...</span>
      </button>
    </div>
  </div>
</div>